/**
 * Contao Open Source CMS
 *
 * @copyright   Andreas Schempp 2011, certo web & design GmbH 2011, MEN AT WORK 2013
 * @package     MultiColumnWizard
 * @license     GNU/LGPL
 * @info        tab is set to 4 whitespaces
 */
var MultiColumnWizard=new Class({Implements:[Options],options:{table:null,maxCount:0,minCount:0,uniqueFields:[]},operationLoadCallbacks:[],operationClickCallbacks:[],operationUpdateCallbacks:[],initialize:function(b){this.setOptions(b);this.options.table=document.id(this.options.table);if(window.Backend){Backend.getScrollOffset()}var a=this;this.options.table.getElement("tbody").getChildren("tr").each(function(d,c){d.getChildren("td.operations a").each(function(e){var f=e.get("rel");if(MultiColumnWizard.operationLoadCallbacks[f]){MultiColumnWizard.operationLoadCallbacks[f].each(function(g){g.pass([e,d],a)()})}if(a.operationLoadCallbacks[f]){a.operationLoadCallbacks[f].each(function(g){g.pass([e,d],a)()})}})});this.updateOperations()},updateOperations:function(){var a=this;this.options.table.getElement("tbody").getChildren("tr").each(function(c,b){c.getChildren("td.operations a").each(function(d){var e=d.get("rel");d.removeEvents("click");if(MultiColumnWizard.operationClickCallbacks[e]){MultiColumnWizard.operationClickCallbacks[e].each(function(f){d.addEvent("click",function(g){g.preventDefault();f.pass([d,c],a)()})})}if(a.operationClickCallbacks[e]){a.operationClickCallbacks[e].each(function(f){d.addEvent("click",function(g){g.preventDefault();f.pass([d,c],a)();a.updateFields(b)})})}d.addEvent("click",function(f){f.preventDefault();a.updateOperations.pass([d,c],a)()});if(MultiColumnWizard.operationUpdateCallbacks[e]){MultiColumnWizard.operationUpdateCallbacks[e].each(function(f){f.pass([d,c],a)()})}if(a.operationUpdateCallbacks[e]){a.operationUpdateCallbacks[e].each(function(f){f.pass([d,c],a)()})}})})},updateRowAttributes:function(d,c){var b=true;var a=0;c.getElements(".mcwUpdateFields *").each(function(g){if(g.hasClass("chzn-container")){g.destroy();return}if(typeOf(g.getProperty("name"))=="string"){var h=g.getProperty("name").match(/([^[\]]+)/g);var i=null;var j="";h.each(function(o,n){if(!isNaN(parseFloat(o))&&isFinite(o)){i=n}});h.each(function(o,n){if(n===0){j+=o}else{if(n===i&&b){j+="["+d+"]"}else{if(n===(i-2)&&!b){j+="["+d+"]"}else{if(n===i&&b){j+="["+a+++"]"}else{j+="["+o+"]"}}}}});g.setProperty("name",j);b=false}if(typeOf(g.getProperty("id"))=="string"){var l=g.getProperty("id").match(/^(.+)_row[0-9]+_(.+)$/i);if(l){g.setProperty("id",l[1]+"_row"+d+"_"+l[2])}}if(typeOf(g.getProperty("onclick"))=="string"){var l=g.getProperty("onclick").match(/^(.+)_row[0-9]+_(.+)$/i);if(l){g.setProperty("onclick",l[1]+"_row"+d+"_"+l[2])}}if(typeOf(g.getProperty("for"))=="string"){var l=g.getProperty("for").match(/^(.+)_row[0-9]+_(.+)$/i);if(l){g.setProperty("for",l[1]+"_row"+d+"_"+l[2])}}switch(g.nodeName.toUpperCase()){case"SELECT":if(g.hasClass("tl_chosen")){new Chosen(g)}break;case"INPUT":if(g.getStyle("display").toLowerCase()=="none"){g.setStyle("display","inline")}if(typeOf(g.getProperty("id"))!="string"){g.destroy()}break;case"SCRIPT":var m="";var k=g.get("html").toString();var f=0;var e=k.search(/_row[0-9]+_/i);while(e>0){f=k.match(/(_row[0-9]+)+_/i)[0].length;m=m+k.substr(0,e)+"_row"+d+"_";k=k.substr(e+f);e=k.search(/_row[0-9]+_/i)}g.set("html",m+k);break}});return c},addOperationLoadCallback:function(a,b){if(!this.operationLoadCallbacks[a]){this.operationLoadCallbacks[a]=[]}this.operationLoadCallbacks[a].include(b)},addOperationUpdateCallback:function(a,b){if(!this.operationUpdateCallbacks[a]){this.operationUpdateCallbacks[a]=[]}this.operationLoadCallbacks[a].include(b)},addOperationClickCallback:function(a,b){if(!this.operationClickCallbacks[a]){this.operationClickCallbacks[a]=[]}this.operationClickCallbacks[a].include(b)},killAllTinyMCE:function(e,g){var d=g.getParent(".multicolumnwizard");if(d.getElements(".tinymce").length==0){return}var b=d.get("id");var c=new RegExp(b);var f=new Array();var a=0;tinyMCE.editors.each(function(i,h){if(i.editorId.match(c)!=null){f[a]=i.editorId;a++}});f.each(function(j,h){try{var i=tinyMCE.get(j);$(i.editorId).set("text",i.getContent());i.remove()}catch(k){console.log(k)}});d.getElements("span.mceEditor").each(function(i,h){i.dispose()});d.getElements(".tinymce").each(function(i,h){i.getElements("script").each(function(k,j){k.dispose()})})},reinitTinyMCE:function(d,e,a){var c=null;if(a!=true){c=e.getParent(".multicolumnwizard")}else{c=e}if(c.getElements(".tinymce").length==0){return}var b=c.getElements(".tinymce textarea");b.each(function(g,f){tinyMCE.execCommand("mceAddControl",false,g.get("id"));tinyMCE.get(g.get("id")).show();$(g.get("id")).erase("required");$(tinyMCE.get(g.get("id")).editorContainer).getElements("iframe")[0].set("title","MultiColumnWizard - TinyMCE")})},reinitStylect:function(){if(window.Stylect){$$(".styled_select").each(function(b,a){b.dispose()});Stylect.convertSelects()}}});Object.append(MultiColumnWizard,{operationLoadCallbacks:{},operationClickCallbacks:{},operationUpdateCallbacks:{},addOperationLoadCallback:function(a,b){if(!MultiColumnWizard.operationLoadCallbacks[a]){MultiColumnWizard.operationLoadCallbacks[a]=[]}MultiColumnWizard.operationLoadCallbacks[a].include(b)},addOperationUpdateCallback:function(a,b){if(!MultiColumnWizard.operationUpdateCallbacks[a]){MultiColumnWizard.operationUpdateCallbacks[a]=[]}MultiColumnWizard.operationUpdateCallbacks[a].include(b)},addOperationClickCallback:function(a,b){if(!MultiColumnWizard.operationClickCallbacks[a]){MultiColumnWizard.operationClickCallbacks[a]=[]}MultiColumnWizard.operationClickCallbacks[a].include(b)},copyUpdate:function(b,c){var a=c.getSiblings().length+1;if(this.options.maxCount>0&&a>=this.options.maxCount){b.setStyle("display","none")}else{b.setStyle("display","inline")}},copyClick:function(b,d){this.killAllTinyMCE(b,d);var a=d.getSiblings().length+1;if(this.options.maxCount==0||(this.options.maxCount>0&&a<this.options.maxCount)){var e=d.clone(true,true);level=d.getAllPrevious().length;e=this.updateRowAttributes(++level,e);e.inject(d,"after");if(e.getElements("script").length>0){e.getElements("script").each(function(f){$exec(f.get("html"))})}var c=this;e.getAllNext().each(function(f){c.updateRowAttributes(++level,f)})}this.reinitTinyMCE(b,d,false);this.reinitStylect()},deleteUpdate:function(b,c){var a=c.getSiblings().length+1;if(this.options.minCount>0&&a<=this.options.minCount){b.setStyle("display","none")}else{b.setStyle("display","inline")}},deleteClick:function(b,e){this.killAllTinyMCE(b,e);var a=e.getParent(".multicolumnwizard");if(e.getSiblings().length>0){var d=e.getAllNext();level=e.getAllPrevious().length;e.dispose();e.destroy.delay(10,e);var c=this;d.each(function(f){c.updateRowAttributes(level++,f)})}else{e.getElements("input,select,textarea").each(function(f){MultiColumnWizard.clearElementValue(f)})}this.reinitTinyMCE(b,a,true)},upClick:function(b,d){this.killAllTinyMCE(b,d);var c=d.getPrevious();if(c){var a=c.getAllPrevious().length;c=this.updateRowAttributes(99999,c);d=this.updateRowAttributes(a,d);c=this.updateRowAttributes(a+1,c);d.inject(c,"before")}this.reinitTinyMCE(b,d,false)},downClick:function(c,d){this.killAllTinyMCE(c,d);var b=d.getNext();if(b){var a=d.getAllPrevious().length;d=this.updateRowAttributes(99999,d);b=this.updateRowAttributes(a,b);d=this.updateRowAttributes(a+1,d);d.inject(b,"after")}this.reinitTinyMCE(c,d,false)},clearElementValue:function(a){if(a.get("type")=="checkbox"||a.get("type")=="radio"){a.checked=false}else{a.set("value","")}}});MultiColumnWizard.addOperationUpdateCallback("copy",MultiColumnWizard.copyUpdate);MultiColumnWizard.addOperationClickCallback("copy",MultiColumnWizard.copyClick);MultiColumnWizard.addOperationUpdateCallback("delete",MultiColumnWizard.deleteUpdate);MultiColumnWizard.addOperationClickCallback("delete",MultiColumnWizard.deleteClick);MultiColumnWizard.addOperationClickCallback("up",MultiColumnWizard.upClick);MultiColumnWizard.addOperationClickCallback("down",MultiColumnWizard.downClick);(function(a){if(!a){return}a.openModalSelectorOriginal=a.openModalSelector;a.openModalSelector=function(b){a.openModalSelectorOriginal(b);var c=null;var f=60;var e=new URI(b.url).getData("field")+"_parent";var d=setInterval(function(){f-=1;var g=window.frames;for(var h=0;h<g.length;h++){if(g[h].name=="simple-modal-iframe"){c=g[h];break}}if(c&&c.document.getElementById(e)){c.document.getElementById(e).set("id",b.id+"_parent");clearInterval(d);return}if(f<=0){clearInterval(d)}},500)}})(window.Backend);
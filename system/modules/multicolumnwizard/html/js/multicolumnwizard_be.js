/**
 * Contao Open Source CMS
 *
 * @copyright   Andreas Schempp 2011, certo web & design GmbH 2011, MEN AT WORK 2013
 * @package     MultiColumnWizard
 * @license     GNU/LGPL
 * @info        tab is set to 4 whitespaces
 */
var MultiColumnWizard=new Class({Implements:[Options],options:{table:null,maxCount:0,minCount:0,uniqueFields:[]},operationLoadCallbacks:[],operationClickCallbacks:[],operationUpdateCallbacks:[],initialize:function(e){this.setOptions(e);this.options.table=document.id(this.options.table);if(window.Backend){Backend.getScrollOffset()}this.contaoVersion=this.getContaoVersion();var t=this;this.options.table.getElement("tbody").getChildren("tr").each(function(e,n){e.getChildren("td.operations a").each(function(n){var r=n.get("rel");if(MultiColumnWizard.operationLoadCallbacks[r]){MultiColumnWizard.operationLoadCallbacks[r].each(function(r){r.pass([n,e],t)()})}if(t.operationLoadCallbacks[r]){t.operationLoadCallbacks[r].each(function(r){r.pass([n,e],t)()})}})});this.updateOperations()},updateOperations:function(){var e=this;this.options.table.getElement("tbody").getChildren("tr").each(function(t,n){t.getChildren("td.operations a").each(function(r){var i=r.get("rel");r.removeEvents("click");if(MultiColumnWizard.operationClickCallbacks[i]){MultiColumnWizard.operationClickCallbacks[i].each(function(n){r.addEvent("click",function(i){i.preventDefault();n.pass([r,t],e)()})})}if(e.operationClickCallbacks[i]){e.operationClickCallbacks[i].each(function(i){r.addEvent("click",function(s){s.preventDefault();i.pass([r,t],e)();e.updateFields(n)})})}r.addEvent("click",function(n){n.preventDefault();e.updateOperations.pass([r,t],e)()});if(MultiColumnWizard.operationUpdateCallbacks[i]){MultiColumnWizard.operationUpdateCallbacks[i].each(function(n){n.pass([r,t],e)()})}if(e.operationUpdateCallbacks[i]){e.operationUpdateCallbacks[i].each(function(n){n.pass([r,t],e)()})}})})},updateRowAttributes:function(e,t){var n=true;var r=0;var i=0;var s=0;var o=0;t.getElements(".mcwUpdateFields *").each(function(t){if(t.hasClass("tl_modulewizard")&&t.hasClass("multicolumnwizard")){n=false;r++;t.addClass("mcw_inner_"+r);s=t.getElement("tbody").getElement("tr").getElements("td.mcwUpdateFields").length;o=1}if(r!==0&&(!t.hasClass("tl_modulewizard")||!t.hasClass("multicolumnwizard"))&&t.getParent(".mcw_inner_"+r)===null){r--;if(r===0){n=true}}if(t.hasClass("chzn-container")){t.destroy();return}if(typeOf(t.getProperty("name"))=="string"){var u=t.getProperty("name").match(/([^[\]]+)/g);var a=null;var f="";u.each(function(e,t){if(!isNaN(parseFloat(e))&&isFinite(e)){a=t}});u.each(function(t,r){if(r===0){f+=t}else if(r===a&&n){f+="["+e+"]"}else if(r===a-2&&!n){f+="["+e+"]"}else if(r===a&&!n){f+="["+i+"]";i=o>0&&o%s==0?++i:i;o++}else{f+="["+t+"]"}});t.setProperty("name",f)}if(typeOf(t.getProperty("id"))=="string"){var l=t.getProperty("id").match(/^(.+)_row[0-9]+_(.+)$/i);if(l){t.setProperty("id",l[1]+"_row"+e+"_"+l[2])}}if(typeOf(t.getProperty("onclick"))=="string"){var l=t.getProperty("onclick").match(/^(.+)_row[0-9]+_(.+)$/i);if(l){t.setProperty("onclick",l[1]+"_row"+e+"_"+l[2])}}if(typeOf(t.getProperty("for"))=="string"){var l=t.getProperty("for").match(/^(.+)_row[0-9]+_(.+)$/i);if(l){t.setProperty("for",l[1]+"_row"+e+"_"+l[2])}}switch(t.nodeName.toUpperCase()){case"SELECT":if(t.hasClass("tl_chosen"))new Chosen(t);break;case"INPUT":if(t.getStyle("display").toLowerCase()=="none")t.setStyle("display","inline");if(typeOf(t.getProperty("id"))!="string")t.destroy();break;case"SCRIPT":var c="";var h=t.get("html").toString();var p=0;var d=h.search(/_row[0-9]+_/i);while(d>0){p=h.match(/(_row[0-9]+)+_/i)[0].length;c=c+h.substr(0,d)+"_row"+e+"_";h=h.substr(d+p);d=h.search(/_row[0-9]+_/i)}t.set("html",c+h);break}});return t},addOperationLoadCallback:function(e,t){if(!this.operationLoadCallbacks[e]){this.operationLoadCallbacks[e]=[]}this.operationLoadCallbacks[e].include(t)},addOperationUpdateCallback:function(e,t){if(!this.operationUpdateCallbacks[e]){this.operationUpdateCallbacks[e]=[]}this.operationLoadCallbacks[e].include(t)},addOperationClickCallback:function(e,t){if(!this.operationClickCallbacks[e]){this.operationClickCallbacks[e]=[]}this.operationClickCallbacks[e].include(t)},killAllTinyMCE:function(e,t){var n=t.getParent(".multicolumnwizard");if(n.getElements(".tinymce").length==0){return}var r=n.get("id");var i=new RegExp(r);var s=new Array;var o=0;tinyMCE.editors.each(function(e,t){if(e.editorId.match(i)!=null){s[o]=e.editorId;o++}});s.each(function(e,t){try{var n=tinyMCE.get(e);$(n.editorId).set("text",n.getContent());n.remove()}catch(r){console.log(r)}});n.getElements("span.mceEditor").each(function(e,t){e.dispose()});n.getElements(".tinymce").each(function(e,t){e.getElements("script").each(function(e,t){e.dispose()})})},reinitTinyMCE:function(e,t,n){var r=null;if(n!=true){r=t.getParent(".multicolumnwizard")}else{r=t}if(r.getElements(".tinymce").length==0){return}var i=r.getElements(".tinymce textarea");i.each(function(e,t){tinyMCE.execCommand("mceAddControl",false,e.get("id"));tinyMCE.get(e.get("id")).show();$(e.get("id")).erase("required");$(tinyMCE.get(e.get("id")).editorContainer).getElements("iframe")[0].set("title","MultiColumnWizard - TinyMCE")})},getContaoVersion:function(){var e=$("top").get("class");var t=/version_(\d)\-(\d)+/g.exec(e);var n=/build_(\d)+/g.exec(e);return{major:parseInt(t[1],10),minor:parseInt(t[2],10),build:parseInt(n[1],10)}},reinitStylect:function(){var e=this.contaoVersion;if(window.Stylect){if(!(e.major>3||e.major===3&&e.minor>=2&&e.build>3)){$$(".styled_select").each(function(e,t){e.dispose()});Stylect.convertSelects()}}}});Object.append(MultiColumnWizard,{operationLoadCallbacks:{},operationClickCallbacks:{},operationUpdateCallbacks:{},addOperationLoadCallback:function(e,t){if(!MultiColumnWizard.operationLoadCallbacks[e]){MultiColumnWizard.operationLoadCallbacks[e]=[]}MultiColumnWizard.operationLoadCallbacks[e].include(t)},addOperationUpdateCallback:function(e,t){if(!MultiColumnWizard.operationUpdateCallbacks[e]){MultiColumnWizard.operationUpdateCallbacks[e]=[]}MultiColumnWizard.operationUpdateCallbacks[e].include(t)},addOperationClickCallback:function(e,t){if(!MultiColumnWizard.operationClickCallbacks[e]){MultiColumnWizard.operationClickCallbacks[e]=[]}MultiColumnWizard.operationClickCallbacks[e].include(t)},copyUpdate:function(e,t){var n=t.getSiblings().length+1;if(this.options.maxCount>0&&n>=this.options.maxCount){e.setStyle("display","none")}else{e.setStyle("display","inline")}},copyClick:function(e,t){this.killAllTinyMCE(e,t);var n=t.getSiblings().length+1;if(this.options.maxCount==0||this.options.maxCount>0&&n<this.options.maxCount){var r=t.clone(true,true);level=t.getAllPrevious().length;r=this.updateRowAttributes(++level,r);r.inject(t,"after");if(r.getElements("script").length>0){r.getElements("script").each(function(e){Browser.exec(e.get("html"))})}var i=this;r.getAllNext().each(function(e){i.updateRowAttributes(++level,e)})}this.reinitTinyMCE(e,t,false);this.reinitStylect()},deleteUpdate:function(e,t){var n=t.getSiblings().length+1;if(this.options.minCount>0&&n<=this.options.minCount){e.setStyle("display","none")}else{e.setStyle("display","inline")}},deleteClick:function(e,t){this.killAllTinyMCE(e,t);var n=t.getParent(".multicolumnwizard");if(t.getSiblings().length>0){var r=t.getAllNext();level=t.getAllPrevious().length;t.dispose();t.destroy.delay(10,t);var i=this;r.each(function(e){i.updateRowAttributes(level++,e)})}else{t.getElements("input,select,textarea").each(function(e){MultiColumnWizard.clearElementValue(e)})}this.reinitTinyMCE(e,n,true)},upClick:function(e,t){this.killAllTinyMCE(e,t);var n=t.getPrevious();if(n){var r=n.getAllPrevious().length;n=this.updateRowAttributes(99999,n);t=this.updateRowAttributes(r,t);n=this.updateRowAttributes(r+1,n);t.inject(n,"before")}this.reinitTinyMCE(e,t,false)},downClick:function(e,t){this.killAllTinyMCE(e,t);var n=t.getNext();if(n){var r=t.getAllPrevious().length;t=this.updateRowAttributes(99999,t);n=this.updateRowAttributes(r,n);t=this.updateRowAttributes(r+1,t);t.inject(n,"after")}this.reinitTinyMCE(e,t,false)},clearElementValue:function(e){if(e.get("type")=="checkbox"||e.get("type")=="radio"){e.checked=false}else{e.set("value","")}}});MultiColumnWizard.addOperationUpdateCallback("copy",MultiColumnWizard.copyUpdate);MultiColumnWizard.addOperationClickCallback("copy",MultiColumnWizard.copyClick);MultiColumnWizard.addOperationUpdateCallback("delete",MultiColumnWizard.deleteUpdate);MultiColumnWizard.addOperationClickCallback("delete",MultiColumnWizard.deleteClick);MultiColumnWizard.addOperationClickCallback("up",MultiColumnWizard.upClick);MultiColumnWizard.addOperationClickCallback("down",MultiColumnWizard.downClick);(function(e){if(!e)return;e.openModalSelectorOriginal=e.openModalSelector;e.openModalSelector=function(t){e.openModalSelectorOriginal(t);var n=null;var r=60;var i=(new URI(t.url)).getData("field")+"_parent";var s=setInterval(function(){r-=1;var e=window.frames;for(var o=0;o<e.length;o++){if(e[o].name=="simple-modal-iframe"){n=e[o];break}}if(n&&n.document.getElementById(i)){n.document.getElementById(i).set("id",t.id+"_parent");clearInterval(s);return}if(r<=0){clearInterval(s)}},500)}})(window.Backend)